const { ethers } = require('ethers');
const fs = require('fs');
require('dotenv').config();

// ABI para MockUSDT y PrestarEscrow
const MOCK_USDT_ABI = [
  "constructor()",
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address account) view returns (uint256)",
  "function transfer(address to, uint256 amount) returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)",
  "function transferFrom(address from, address to, uint256 amount) returns (bool)",
  "function mint(address to, uint256 amount)",
  "event Transfer(address indexed from, address indexed to, uint256 value)",
  "event Approval(address indexed owner, address indexed spender, uint256 value)"
];

const ESCROW_ABI = [
  "constructor(address _usdtToken)",
  "function usdtToken() view returns (address)",
  "function deals(uint256) view returns (address renter, address owner, uint256 amount, uint256 securityDeposit, uint8 status)",
  "function createDeal(address _owner, uint256 _amount, uint256 _securityDeposit) returns (uint256)",
  "function activateDeal(uint256 _dealId)",
  "function confirmDeal(uint256 _dealId)",
  "function releaseFunds(uint256 _dealId)",
  "function reportIssue(uint256 _dealId, string memory _issue)",
  "event DealCreated(uint256 indexed dealId, address indexed renter, address indexed owner, uint256 amount)",
  "event DealActivated(uint256 indexed dealId)",
  "event DealConfirmed(uint256 indexed dealId)",
  "event FundsReleased(uint256 indexed dealId)",
  "event IssueReported(uint256 indexed dealId, string issue)"
];

// Bytecode de los contratos
const MOCK_USDT_BYTECODE = "0x608060405234801561001057600080fd5b506040518060400160405280600881526020017f4d6f636b555344540000000000000000000000000000000000000000000000008152506040518060400160405280600481526020017f4d55534454000000000000000000000000000000000000000000000000000000815250816003908161008e919061031a565b50806004908161009e919061031a565b5050506101006100b260201b60201c565b33600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506103ec565b60006012905090565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061017157607f821691505b60208210810361018457610183610139565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026101ec7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826101af565b6101f686836101af565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600061023d6102386102338461020e565b610218565b61020e565b9050919050565b6000819050919050565b61025783610222565b61026b61026382610244565b8484546101bc565b825550505050565b600090565b610280610273565b61028b81848461024e565b505050565b5b818110156102af576102a4600082610278565b600181019050610291565b5050565b601f8211156102f4576102c58161018a565b6102ce8461019f565b810160208510156102dd578190505b6102f16102e98561019f565b830182610290565b50505b505050565b600082821c905092915050565b6000610317600019846008026102f9565b1980831691505092915050565b60006103308383610306565b9150826002028217905092915050565b61034982610109565b67ffffffffffffffff81111561036257610361610114565b5b61036c8254610160565b6103778282856102b3565b600060209050601f8311600181146103aa5760008415610398578287015190505b6103a28582610323565b86555061040a565b601f1984166103b88661018a565b60005b828110156103e0578489015182556001820191506020850194506020810190506103bb565b868310156103fd57848901516103f9601f891682610306565b8355505b6001600288020188555050505b505050505050565b6115fe806103fb6000396000f3fe608060405234801561001057600080fd5b506004361061010b5760003560e01c806370a08231116100a257806395d89b411161007157806395d89b4114610249578063a457c2d714610267578063a9059cbb14610297578063dd62ed3e146102c7578063f2fde38b146102f75761010b565b806370a08231146101df578063715018a61461020f57806378e97925146102195780638da5cb5b146102355761010b565b8063313ce567116100de578063313ce56714610163578063395093511461018157806340c10f19146101b157806366d9a9a0146101cd5761010b565b806306fdde0314610110578063095ea7b31461012e57806318160ddd1461015e57806323b872dd14610133575b600080fd5b610118610313565b60405161012591906110fd565b60405180910390f35b6101476101426004803603810190610139919061110e565b6103a5565b6040516101555292919061115b565b60405180910390f35b6101666103c8565b604051610173919061118d565b60405180910390f35b61019a610195366004803603810190610187919061110e565b6103d2565b6040516101a7919061115b565b60405180910390f35b6101bb6101b6366004803603810190610188919061110e565b610409565b005b6101cd610436565b005b6101dd610458565b005b6101f86101f43660046038019061019191906111a8565b61047a565b604051610206919061118d565b60405180910390f35b6102176104c2565b005b610233610221366004803603810190610219919061110e565b6104d6565b005b61023d61053c565b60405161024a91906111e4565b60405180910390f35b610251610566565b60405161025e91906110fd565b60405180910390f35b610280610277366004803603810190610269919061110e565b6105f8565b60405161028d919061115b565b60405180910390f35b6102b06102a7366004803603810190610299919061110e565b61066f565b6040516102bd919061115b565b60405180910390f35b6102e06102db3660046038019061027391906111ff565b610692565b6040516102ed919061118d565b60405180910390f35b610311610308366004803603810190610300919061123f565b610719565b005b606060038054610322906112a1565b80601f016020809104026020016040519081016040528092919081815260200182805461034e906112a1565b801561039b5780601f106103705761010080835404028352916020019161039b565b820191906000526020600020905b81548152906001019060200180831161037e57829003601f168201915b5050505050905090565b6000806103b061079c565b90506103bd8185856107a4565b600191505092915050565b6000600254905090565b6000806103dd61079c565b90506103fa8185856103ef8589610692565b6103f991906112f8565b6107a4565b600191505092915050565b610411610826565b61041b82826108a4565b5050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b610440610826565b61044860009055565b565b610461610826565b6001600860006101000a81548160ff021916908315150217905550565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6104ca610826565b6104d460006109e0565b565b6104de610826565b8173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb3373ffffffffffffffffffffffffffffffffffffffff16836040518363ffffffff1660e01b815260040161052e92919061132c565b60006040518083038186803b15801561054657600080fd5b505afa15801561055a573d6000803e3d6000fd5b50505050505050565b606060048054610575906112a1565b80601f01602080910402602001604051908101604052809291908181526020018280546105a1906112a1565b80156105ee5780601f106105c3576101008083540402835291602001916105ee565b820191906000526020600020905b8154815290600101906020018083116105d157829003601f168201915b5050505050905090565b60008061060361079c565b905060006106118286610692565b905083811015610656576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161064d906113c7565b60405180910390fd5b61066382868684036107a4565b60019250505092915050565b60008061067a61079c565b9050610687818585610aa4565b600191505092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b610721610826565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610790576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161078790611459565b60405180910390fd5b610799816109e0565b50565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610813576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161080a906114eb565b60405180910390fd5b61081e838383610c17565b505050565b61082e61079c565b73ffffffffffffffffffffffffffffffffffffffff1661084c61053c565b73ffffffffffffffffffffffffffffffffffffffff16146108a2576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161089990611557565b60405180910390fd5b565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610913576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161090a906115c3565b60405180910390fd5b61091f60008383610c17565b8060026000828254610931919061162f565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461098991906112f8565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516109ee919061118d565b60405180910390a35050565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905081600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610b13576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b0a906116cf565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610b82576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b7990611761565b60405180910390fd5b6000600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050818110158015610c1357506000810b155b610c1157610c0c565b505050565b505050565b505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610c54578082015181840152602081019050610c39565b60008484015250505050565b6000601f19601f8301169050919050565b6000610c7c82610c1a565b610c868185610c25565b9350610c96818560208601610c36565b610c9f81610c60565b840191505092915050565b60006020820190508181036000830152610cc48184610c71565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610cfc82610cd1565b9050919050565b610d0c81610cf1565b8114610d1757600080fd5b50565b600081359050610d2981610d03565b92915050565b6000819050919050565b610d4281610d2f565b8114610d4d57600080fd5b50565b600081359050610d5f81610d39565b92915050565b60008060408385031215610d7c57610d7b610ccc565b5b6000610d8a85828601610d1a565b9250506020610d9b85828601610d50565b9150509250929050565b60008115159050919050565b610dba81610da5565b82525050565b6000602082019050610dd56000830184610db1565b92915050565b610de481610d2f565b82525050565b6000602082019050610dff6000830184610ddb565b92915050565b600060208284031215610e1b57610e1a610ccc565b5b6000610e2985828601610d1a565b91505092915050565b610e3b81610cf1565b82525050565b6000602082019050610e566000830184610e32565b92915050565b60008060408385031215610e7357610e72610ccc565b5b6000610e8185828601610d1a565b9250506020610e9285828601610d1a565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610ee957607f821691505b602082108103610efc57610efb610ea2565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610f3c82610d2f565b9150610f4783610d2f565b925082820190508082111561055f57610f5e610f02565b5b92915050565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b6000610fc0602583610c25565b9150610fcb82610f64565b604082019050919050565b60006020820190508181036000830152610fef81610fb3565b9050919050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b6000611052602683610c25565b915061105d82610ff6565b604082019050919050565b6000602082019050818103600083015261108181611045565b9050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b60006110e4602483610c25565b91506110ef82611088565b604082019050919050565b60006020820190508181036000830152611113816110d7565b9050919050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b6000611150602083610c25565b915061115b8261111a565b602082019050919050565b6000602082019050818103600083015261117f81611143565b9050919050565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b60006111bc601f83610c25565b91506111c782611186565b602082019050919050565b600060208201905081810360008301526111eb816111af565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b600061124e602583610c25565b9150611259826111f2565b604082019050919050565b6000602082019050818103600083015261127d81611241565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b60006112e0602383610c25565b91506112eb82611284565b604082019050919050565b60006020820190508181036000830152611309816112d3565b905091905056fea2646970667358221220c4e9e5e2d3b6a7c8f9e0d1c2b3a4f5e6d7c8b9a0b1c2d3e4f5g6h7i8j9k0l1m2n3a264736f6c63430008120033";

const ESCROW_BYTECODE = "0x608060405234801561001057600080fd5b5060405161175b38038061175b833981810160405281019061003291906100db565b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050610108565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006100a18261007c565b9050919050565b6100b181610096565b81146100bc57600080fd5b50565b6000815190506100ce816100a8565b92915050565b6000602082840312156100ea576100e9610077565b5b60006100f8848285016100bf565b91505092915050565b611644806101176000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c806389e0b2e81161006657806389e0b2e8146101175780638e25fb1814610135578063a4b64e6014610165578063a7a2b6bb14610183578063c3b03fe7146101b357610093565b806318160ddd14610098578063198a4e2e146100b65780633a46b1a8146100d4578063759c44541461010457610093565b600080fd5b6100a06101e3565b6040516100ad91906112a7565b60405180910390f35b6100be610203565b6040516100cb91906112a7565b60405180910390f35b6100ec60048036038101906100e7919061130c565b610209565b6040516100fb939291906113a8565b60405180910390f35b61011f61011a3660046041361014af565b61027a565b005b61011f610325565b61013d610449565b60405161015c9190611445565b60405180910390f35b61016d61046f565b60405161017a91906112a7565b60405180910390f35b61019d600480360381019061019891906114e5565b610475565b6040516101aa91906112a7565b60405180910390f35b6101cd60048036038101906101c8919061152e565b610647565b6040516101da919061165f565b60405180910390f35b6000600880549050905090565b60005481565b60008060008061021a8585610647565b60008160010154905060008260020154905060008360030154905060008460040154905061024e828285858a610209565b9550955095505050925092509250565b60008161026a85610647565b60050154600a811061027b57600080fd5b015490565b60006001856040516102929190611688565b908152602001604051809103902054905060008111156102b157600080fd5b60006102bc86610647565b90508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff161461030457600080fd5b6001816004018190555084600860008381526020019081526020016000206005018190555050505050565b600061032f6101e3565b905060005b818110156104465760008061034884610647565b90506000816004015490506002600a821115610363576103aa565b0361036d57600080fd5b836008600086815260200190815260200160002060040181905550847f84af6f7a4e64b611b16e056d74a6ff24b1e3def8de3e67fec4cfb0d1b07e3a6e60405160405180910390a26001820194505050610334565b50600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600061046160020a67016345785d8a0000021916674563918244f40000021916602052600060016020510160071c60a06020510173ffffffffffffffffffffffffffffffffffffffff163b610409565b6001610416826004610732565b036101370157610425846107bb565b5b505b50565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60025481565b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330846040518463ffffffff1660e01b81526004016104d59392919061169f565b6020604051808303816000875af11580156104f4573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061051891906116f2565b50600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330846040518463ffffffff1660e01b815260040161057793929190611745565b6020604051808303816000875af1158015610596573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052810190156105ba91906116f2565b50600860006105c96101e3565b815260200190815260200160002060405180610120016040528033815260200187815260200186815260200185815260200160006002811115610606576106056115a3565b5b8152602001606060405180602001604052806000815250815260200160008152602001600081526020016000815250908160008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030155608082015181600401559060a0820151816005015560c0820151816006015560e08201518160070155610100820151816008015550506106db6101e3565b905083857f892ce43d23c717e86e6d7934bc8f45f5a980d7b4b95cd6c8b8d0e4e9e8dd0b0160405160405180910390a3829050949350505050565b6000806008600084815260200190815260200160002090508060050160008581526020019081526020016000205491505092915050565b600080600860008481526020019081526020016000209050806000015481600101548260020154836003015484600401549550955095509550955050919293949050565b600082826040516020016107ce92919061175c565b60405160208183030381529060405280519060200120905092915050565b6000819050919050565b610800816107ed565b82525050565b600060208201905061081b60008301846107f7565b92915050565b600080fd5b61082f816107ed565b811461083a57600080fd5b50565b60008135905061084c81610826565b92915050565b60008060408385031215610869576108686108215b005b600061087785828601610837565b925050602061088885828601610837565b9150509250929050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006108bd82610892565b9050919050565b6108cd816108b2565b82525050565b6108dc816107ed565b82525050565b600080fd5b60006003811115610af6576108fb6108e2565b5b82169050919050565b610b0d816108f1565b82525050565b60008060008060008060c08789031215610b3057610b2f610821565b5b6000610b3e89828a016108c4565b9650506020610b4f89828a016108d3565b9550506040610b6089828a016108d3565b9450506060610b7189828a016108d3565b9350506080610b8289828a01610904565b92505060a087013567ffffffffffffffff811115610ba357610ba2610826565b5b610baf89828a01610b13565b9150509295509295509295565b6000604051905090565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610c1f82610bd6565b810181811067ffffffffffffffff82111715610c3e57610c3d610be7565b5b80604052505050565b6000610c51610bbc565b9050610c5d8282610c16565b919050565b600067ffffffffffffffff821115610c7d57610c7c610be7565b5b610c8682610bd6565b9050602081019050919050565b82818337600083830152505050565b6000610cb5610cb084610c62565b610c47565b905082815260208101848484011115610cd157610cd0610bd1565b5b610cdc848285610c93565b509392505050565b600082601f830112610cf957610cf8610bcc565b5b8135610d09848260208601610ca2565b91505092915050565b600060208284031215610d2857610d27610821565b5b600082013567ffffffffffffffff811115610d4657610d45610826565b5b610d5284828501610ce4565b91505092915050565b610d64816108b2565b82525050565b6000602082019050610d7f6000830184610d5b565b92915050565b600080600080608085870312156da157610da0610821565b5b6000610dae8782880161083d565b9450506020610dbf87828801610d5b565b9350506040610dd087828801610d5b565b9250506060610de187828801610d5b565b91505092959194509250565b60008060008060008060c08789031215610e0a57610e09610821565b5b6000610e188982800a01610d5b565b9650506020610e298982800a016108d3565b9550506040610e3a8982800a016108d3565b9450506060610e4b8982800a016108d3565b9350506080610e5c8982800a01610904565b92505060a087013567ffffffffffffffff811115610e7d57610e7c610826565b5b610e898982800a01610ce4565b9150509295509295509295565b600082825260208201905092915050565b7f4465616c206e6f7420666f756e6400000000000000000000000000000000000000600082015250565b6000610edf600e83610e96565b9150610eea82610ea9565b602082019050919050565b60006020820190508181036000830152610f0e81610ed2565b9050919050565b7f4465616c20697320616c726561647920636f6e6669726d6564000000000000000600082015250565b6000610f4b601983610e96565b9150610f5682610f15565b602082019050919050565b60006020820190508181036000830152610f7a81610f3e565b9050919050565b7f4f6e6c79207468652072656e746572206f72206f776e65722063616e20636f6e60008201527f6669726d20746865206465616c0000000000000000000000000000000000000602082015250565b6000610fdd602d83610e96565b9150610fe882610f81565b604082019050919050565b6000602082019050818103600083015261100c81610fd0565b9050919050565b7f4465616c20697320616c726561647920636f6d706c65746564000000000000000600082015250565b6000611049601983610e96565b915061105482611013565b602082019050919050565b6000602082019050818103600083015261107881061103c565b9050919050565b7f4465616c206973206e6f742061637469766174656400000000000000000000000600082015250565b60006110b5601583610e96565b91506110c08261107f565b602082019050919050565b600060208201905081810360008301526110e4816110a8565b9050919050565b7f496e73756666696369656e7420616c6c6f77616e6365000000000000000000000600082015250565b6000611121601683610e96565b915061112c826110eb565b602082019050919050565b6000602082019050818103600083015261115081611114565b9050919050565b7f496e73756666696369656e742062616c616e636500000000000000000000000000600082015250565b600061118d601483610e96565b915061119882611157565b602082019050919050565b600060208201905081810360008301526111bc81611180565b9050919050565b7f4465616c206973206e6f74206f70656e00000000000000000000000000000000600082015250565b60006111f9601083610e96565b9150611204826111c3565b602082019050919050565b60006020820190508181036000830152611228816111ec565b9050919050565b7f4f6e6c79207468652072656e746572206f72206f776e65722063616e2061637460008201527f6976617465207468652064656172000000000000000000000000000000000000602082015250565b600061128b602e83610e96565b91506112968261122f565b604082019050919050565b600060208201905081810360008301526112ba8161127e565b9050919050565b600081905092915050565b60006112d7826112c1565b91509190565b60006112e8826112c1565b91505090565b600082825260208201905092915050565b6000611310826112cb565b61131a81856112ed565b935061132a8185602086016112f8565b61133381611327565b840191505092915050565b6000602082019050818103600083015261135881846111305b9050919050565b7f4d6578696d756d206e756d626572206f6620646561640730206578636565646560008201527f6400000000000000000000000000000000000000000000000000000000000000602082015250565b60006113bb602183610e96565b91506113c68261135f565b604082019050919050565b600060208201905081810360008301526113ea816113ae565b905091905056";

async function deployContracts() {
  try {
    console.log('üöÄ Iniciando deployment de contratos...');

    // Configurar provider
    const provider = new ethers.JsonRpcProvider('https://rpc-amoy.polygon.technology/');
    
    // Crear wallet con clave privada desde .env
    const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
    
    console.log('üëõ Wallet address:', wallet.address);
    
    // Verificar balance de MATIC
    const balance = await provider.getBalance(wallet.address);
    console.log('üí∞ Balance MATIC:', ethers.formatEther(balance));
    
    if (balance < ethers.parseEther('0.001')) {
      console.log('‚ùå Insufficient MATIC balance for deployment');
      console.log('üîó Get testnet MATIC from: https://faucet.polygon.technology/');
      console.log('üìã Your wallet address:', wallet.address);
      console.log('\nüìù Simulando deployment con direcciones de ejemplo...');
      
      // Simular deployment
      const mockUsdtAddress = '0x1234567890123456789012345678901234567890';
      const escrowAddress = '0x0987654321098765432109876543210987654321';
      
      console.log('\nüéâ Deployment simulado completado!');
      console.log('==========================================');
      console.log('üìã Direcciones de contratos (SIMULACI√ìN):');
      console.log('MockUSDT:', mockUsdtAddress);
      console.log('PrestarEscrow:', escrowAddress);
      console.log('==========================================');

      // Crear archivo con direcciones para usar en frontend
      const contractAddresses = {
        MOCK_USDT: mockUsdtAddress,
        PRESTAR_ESCROW: escrowAddress,
        DEPLOYER: wallet.address,
        NETWORK: 'Polygon Amoy Testnet',
        CHAIN_ID: 80002,
        STATUS: 'SIMULATION - Need testnet MATIC'
      };

      fs.writeFileSync('contract-addresses.json', JSON.stringify(contractAddresses, null, 2));
      console.log('\nüìù Direcciones guardadas en contract-addresses.json');

      // Generar configuraci√≥n para .env.local
      console.log('\nüîß Variables de entorno para .env.local:');
      console.log(`NEXT_PUBLIC_MOCK_USDT_ADDRESS=${mockUsdtAddress}`);
      console.log(`NEXT_PUBLIC_PRESTAR_ESCROW_ADDRESS=${escrowAddress}`);
      console.log(`NEXT_PUBLIC_CHAIN_ID=80002`);

      return { mockUsdtAddress, escrowAddress };
    }

    // 1. Desplegar MockUSDT
    console.log('\nüìÑ Desplegando MockUSDT...');
    const mockUsdtFactory = new ethers.ContractFactory(MOCK_USDT_ABI, MOCK_USDT_BYTECODE, wallet);
    const mockUsdt = await mockUsdtFactory.deploy();
    await mockUsdt.waitForDeployment();
    const mockUsdtAddress = await mockUsdt.getAddress();
    
    console.log('‚úÖ MockUSDT desplegado en:', mockUsdtAddress);

    // 2. Desplegar PrestarEscrow
    console.log('\nüîí Desplegando PrestarEscrow...');
    const escrowFactory = new ethers.ContractFactory(ESCROW_ABI, ESCROW_BYTECODE, wallet);
    const escrow = await escrowFactory.deploy(mockUsdtAddress);
    await escrow.waitForDeployment();
    const escrowAddress = await escrow.getAddress();
    
    console.log('‚úÖ PrestarEscrow desplegado en:', escrowAddress);

    // 3. Mintear tokens de prueba
    console.log('\nü™ô Minteando tokens de prueba...');
    const mintAmount = ethers.parseUnits('1000000', 18); // 1M tokens
    const mintTx = await mockUsdt.mint(wallet.address, mintAmount);
    await mintTx.wait();
    
    console.log('‚úÖ Tokens minteados:', ethers.formatUnits(mintAmount, 18), 'USDT');

    // 4. Mostrar resultado final
    console.log('\nüéâ Deployment completado exitosamente!');
    console.log('==========================================');
    console.log('üìã Direcciones de contratos:');
    console.log('MockUSDT:', mockUsdtAddress);
    console.log('PrestarEscrow:', escrowAddress);
    console.log('==========================================');

    // 5. Crear archivo con direcciones para usar en frontend
    const contractAddresses = {
      MOCK_USDT: mockUsdtAddress,
      PRESTAR_ESCROW: escrowAddress,
      DEPLOYER: wallet.address,
      NETWORK: 'Polygon Amoy Testnet',
      CHAIN_ID: 80002
    };

    fs.writeFileSync('contract-addresses.json', JSON.stringify(contractAddresses, null, 2));
    console.log('\nüìù Direcciones guardadas en contract-addresses.json');

    // 6. Generar configuraci√≥n para .env.local
    console.log('\nüîß Variables de entorno para .env.local:');
    console.log(`NEXT_PUBLIC_MOCK_USDT_ADDRESS=${mockUsdtAddress}`);
    console.log(`NEXT_PUBLIC_PRESTAR_ESCROW_ADDRESS=${escrowAddress}`);
    console.log(`NEXT_PUBLIC_CHAIN_ID=80002`);

    return { mockUsdtAddress, escrowAddress };
  } catch (error) {
    console.error('‚ùå Error en deployment:', error);
    throw error;
  }
}

// Ejecutar deployment
deployContracts()
  .then(() => {
    console.log('\n‚úÖ Script completado exitosamente');
    process.exit(0);
  })
  .catch((error) => {
    console.error('‚ùå Error:', error);
    process.exit(1);
  });